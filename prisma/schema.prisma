generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model platform_billing_cycles {
  id                String        @id @default(cuid())
  subscription_id   String
  period_start      DateTime
  period_end        DateTime
  amount            Decimal
  status            String
  stripe_invoice_id String?
  created_at        DateTime      @default(now())
  subscriptions     subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade)

  @@index([period_start, period_end])
  @@index([status])
  @@index([subscription_id])
}

model platform_config {
  id                    String   @id @default(cuid())
  nombre_empresa        String
  logo_url              String?
  favicon_url           String?
  comercial_telefono    String?
  comercial_email       String?
  comercial_whatsapp    String?
  soporte_telefono      String?
  soporte_email         String?
  soporte_chat_url      String?
  direccion             String?
  horarios_atencion     String?
  timezone              String   @default("America/Mexico_City")
  facebook_url          String?
  instagram_url         String?
  twitter_url           String?
  linkedin_url          String?
  terminos_condiciones  String?
  politica_privacidad   String?
  aviso_legal           String?
  meta_description      String?
  meta_keywords         String?
  google_analytics_id   String?
  google_tag_manager_id String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime
}

model platform_services {
  id            String             @id @default(cuid())
  name          String             @unique
  slug          String             @unique
  description   String?
  active        Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  posicion      Int                @default(0)
  categoryId    String
  plan_services plan_services[]
  category      service_categories @relation(fields: [categoryId], references: [id])

  @@index([active, posicion])
  @@index([categoryId])
}

model platform_acquisition_channels {
  id             String           @id @default(cuid())
  name           String           @unique
  description    String?
  color          String?
  icon           String?
  isActive       Boolean          @default(true)
  isVisible      Boolean          @default(true)
  order          Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  platform_leads platform_leads[]

  @@index([isActive])
  @@index([isVisible])
}

model platform_lead_bitacora {
  id             String                   @id @default(cuid())
  leadId         String
  tipo           PlatformLeadBitacoraTipo
  titulo         String?
  descripcion    String
  metadata       Json?
  usuarioId      String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime
  platform_leads platform_leads           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user_profiles  studio_user_profiles?    @relation(fields: [usuarioId], references: [id])

  @@index([createdAt])
  @@index([leadId])
  @@index([tipo])
}

model platform_leads {
  id                            String                          @id @default(cuid())
  name                          String
  email                         String                          @unique
  phone                         String
  studioName                    String?
  studioSlug                    String?
  lastContactDate               DateTime?
  interestedPlan                String?
  avatarUrl                     String?
  probableStartDate             DateTime?
  agentId                       String?
  score                         Int?
  priority                      String                          @default("medium")
  conversionDate                DateTime?
  studioId                      String?                         @unique
  createdAt                     DateTime                        @default(now())
  updatedAt                     DateTime
  stageId                       String?
  acquisitionChannelId          String?
  campaignId                    String?                         @map("campañaId")
  agentConversionId             String?
  firstInteractionDate          DateTime?
  originalSource                String?
  conversionMethod              String?
  interactionCount              Int?                            @default(0)
  leadType                      String?                         @default("prospect")
  utm_campaign                  String?
  utm_medium                    String?
  utm_source                    String?
  platform_activities           platform_activities[]
  agent_discount_codes          platform_agent_discount_codes[]
  discount_usage                platform_discount_usage[]
  platform_lead_bitacora        platform_lead_bitacora[]
  platform_acquisition_channels platform_acquisition_channels?  @relation(fields: [acquisitionChannelId], references: [id])
  platform_agents               platform_agents?                @relation(fields: [agentId], references: [id])
  platform_campaigns            platform_campaigns?             @relation(fields: [campaignId], references: [id])
  platform_pipeline_stages      platform_pipeline_stages?       @relation(fields: [stageId], references: [id])
  studio                        studios?                        @relation(fields: [studioId], references: [id])
  platform_notifications        platform_notifications[]

  @@index([agentId])
  @@index([campaignId])
  @@index([acquisitionChannelId])
  @@index([stageId, priority])
}

model platform_notifications {
  id              String               @id @default(cuid())
  userId          String
  titulo          String
  mensaje         String
  tipo            String               @default("info")
  categoria       String               @default("general")
  metadata        Json?
  isRead          Boolean              @default(false)
  isActive        Boolean              @default(true)
  priority        String               @default("medium")
  leadId          String?
  agentId         String?
  scheduledFor    DateTime?
  expiresAt       DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime
  platform_agents platform_agents?     @relation(fields: [agentId], references: [id])
  platform_leads  platform_leads?      @relation(fields: [leadId], references: [id])
  user_profiles   studio_user_profiles @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([scheduledFor])
  @@index([tipo, categoria])
  @@index([userId, isActive])
  @@index([userId, isRead])
}

model platform_pipeline_types {
  id              String                     @id @default(cuid())
  nombre          String                     @unique
  descripcion     String?
  color           String                     @default("#3B82F6")
  activo          Boolean                    @default(true)
  orden           Int                        @default(0)
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime
  pipeline_stages platform_pipeline_stages[]

  @@index([activo])
  @@index([orden])
}

model platform_pipeline_stages {
  id               String                   @id @default(cuid())
  nombre           String
  descripcion      String?
  color            String                   @default("#3B82F6")
  orden            Int                      @default(0)
  isActive         Boolean                  @default(true)
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime
  pipeline_type_id String?
  platform_leads   platform_leads[]
  pipeline_type    platform_pipeline_types? @relation(fields: [pipeline_type_id], references: [id])

  @@index([isActive])
  @@index([orden])
  @@index([pipeline_type_id])
}

model platform_advertising_platforms {
  id                          String                        @id @default(cuid())
  name                        String                        @unique
  description                 String?
  type                        String
  color                       String?
  icon                        String?
  isActive                    Boolean                       @default(true)
  order                       Int                           @default(0)
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  platform_campaign_platforms platform_campaign_platforms[]

  @@index([isActive])
  @@index([type])
}

model platform_plans {
  id                String          @id @default(cuid())
  name              String
  slug              String          @unique
  features          Json?
  popular           Boolean         @default(false)
  active            Boolean         @default(true)
  orden             Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  description       String?
  limits            Json?
  price_monthly     Decimal?
  price_yearly      Decimal?
  stripe_price_id   String?         @unique
  stripe_product_id String?
  plan_services     plan_services[]
  studios           studios[]
  subscriptions     subscriptions[]

  @@index([active, orden])
  @@index([stripe_price_id])
}

model platform_activities {
  id                 String                @id @default(cuid())
  leadId             String
  tipo               String
  descripcion        String
  resultado          String?
  proximaAccion      String?
  fechaProximaAccion DateTime?
  createdAt          DateTime              @default(now())
  userId             String?
  platform_leads     platform_leads        @relation(fields: [leadId], references: [id])
  user_profiles      studio_user_profiles? @relation(fields: [userId], references: [id])

  @@index([leadId, createdAt])
  @@index([userId, createdAt])
}

model platform_agents {
  id                     String                          @id @default(cuid())
  nombre                 String
  email                  String                          @unique
  telefono               String
  activo                 Boolean                         @default(true)
  metaMensualLeads       Int                             @default(20)
  comisionConversion     Decimal                         @default(0.05)
  createdAt              DateTime                        @default(now())
  updatedAt              DateTime
  agent_discount_codes   platform_agent_discount_codes[]
  platform_leads         platform_leads[]
  platform_notifications platform_notifications[]

  @@index([activo])
}

model platform_campaign_platforms {
  id                             String                         @id @default(cuid())
  campaignId                     String                         @map("campañaId")
  platformId                     String
  budget                         Decimal
  actualSpend                    Decimal                        @default(0)
  leads                          Int                            @default(0)
  conversions                    Int                            @default(0)
  createdAt                      DateTime                       @default(now())
  updatedAt                      DateTime
  platform_campaigns             platform_campaigns             @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  platform_advertising_platforms platform_advertising_platforms @relation(fields: [platformId], references: [id])

  @@unique([campaignId, platformId])
  @@index([campaignId])
  @@index([platformId])
}

model platform_campaigns {
  id                          String                        @id @default(cuid())
  name                        String
  description                 String?
  totalBudget                 Decimal
  startDate                   DateTime
  endDate                     DateTime
  isActive                    Boolean                       @default(true)
  status                      String                        @default("planned")
  leadsGenerated              Int                           @default(0)
  leadsSubscribed             Int                           @default(0)
  actualSpend                 Decimal                       @default(0)
  studio_id                   String?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime
  platform_campaign_platforms platform_campaign_platforms[]
  studio                      studios?                      @relation(fields: [studio_id], references: [id])
  platform_leads              platform_leads[]

  @@index([startDate, endDate])
  @@index([isActive])
  @@index([status])
  @@index([studio_id])
}

model platform_discount_codes {
  id               String                    @id @default(cuid())
  codigo           String                    @unique
  nombre           String
  descripcion      String?
  tipo_descuento   String
  valor_descuento  Decimal
  tipo_aplicacion  String
  fecha_inicio     DateTime
  fecha_fin        DateTime
  uso_maximo       Int?
  uso_actual       Int                       @default(0)
  activo           Boolean                   @default(true)
  stripe_coupon_id String?                   @unique
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime
  discount_usage   platform_discount_usage[]

  @@index([activo])
  @@index([fecha_inicio, fecha_fin])
  @@index([stripe_coupon_id])
}

model platform_discount_usage {
  id               String                  @id @default(cuid())
  discount_code_id String
  lead_id          String?
  subscription_id  String?
  monto_descuento  Decimal
  fecha_uso        DateTime                @default(now())
  discount_code    platform_discount_codes @relation(fields: [discount_code_id], references: [id])
  lead             platform_leads?         @relation(fields: [lead_id], references: [id])
  subscription     subscriptions?          @relation(fields: [subscription_id], references: [id])

  @@index([discount_code_id])
  @@index([lead_id])
  @@index([subscription_id])
  @@index([fecha_uso])
}

model platform_agent_discount_codes {
  id                 String          @id @default(cuid())
  codigo_base        String
  lead_id            String
  agente_id          String
  codigo_completo    String          @unique
  tipo_descuento     String
  valor_descuento    Decimal
  duracion_descuento String
  stripe_coupon_id   String?         @unique
  fecha_creacion     DateTime        @default(now())
  fecha_expiracion   DateTime
  usado              Boolean         @default(false)
  fecha_uso          DateTime?
  subscription_id    String?
  activo             Boolean         @default(true)
  agente             platform_agents @relation(fields: [agente_id], references: [id])
  lead               platform_leads  @relation(fields: [lead_id], references: [id])
  subscription       subscriptions?  @relation(fields: [subscription_id], references: [id])

  @@index([lead_id])
  @@index([agente_id])
  @@index([codigo_completo])
  @@index([usado])
  @@index([fecha_expiracion])
}

model studios {
  id                         String                           @id @default(cuid())
  studio_name                String
  slug                       String                           @unique
  email                      String                           @unique
  phone                      String?
  address                    String?
  website                    String?
  logo_url                   String?
  plan_id                    String?
  subscription_status        SubscriptionStatus               @default(TRIAL)
  subscription_start         DateTime?
  subscription_end           DateTime?
  stripe_customer_id         String?                          @unique
  stripe_subscription_id     String?                          @unique
  stripe_account_id          String?                          @unique
  stripe_onboarding_complete Boolean                          @default(false)
  commission_rate            Decimal                          @default(0.30)
  is_active                  Boolean                          @default(true)
  created_at                 DateTime                         @default(now())
  updated_at                 DateTime                         @updatedAt
  descripcion                String?
  isotipo_url                String?
  palabras_clave             String?
  slogan                     String?
  platform_campaigns         platform_campaigns[]
  platform_leads             platform_leads?
  platform_user_profiles     platform_user_profiles[]
  agenda                     studio_agenda[]
  categorias_personal        studio_categorias_personal[]
  clientes                   studio_clientes[]
  condiciones_comerciales    studio_condiciones_comerciales[]
  configuraciones            studio_configuraciones[]
  cotizaciones               studio_cotizaciones[]
  cuentas_bancarias          studio_cuentas_bancarias[]
  eventos                    studio_eventos[]
  gastos                     studio_gastos[]
  horarios_atencion          studio_horarios_atencion[]
  metodos_pago               studio_metodos_pago[]
  nominas                    studio_nominas[]
  paquetes                   studio_paquetes[]
  evento_tipos               studio_evento_tipos[]
  personal                   studio_personal[]
  personal_profiles          studio_personal_profiles[]
  redes_sociales             studio_redes_sociales[]
  reglas_agendamiento        studio_reglas_agendamiento[]
  revenue_transactions       studio_revenue_transactions[]
  servicios                  studio_servicios[]
  studio_revenue_products    studio_studio_revenue_products[]
  telefonos                  studio_telefonos[]
  user_profiles              studio_user_profiles[]
  studio_users               studio_users[]
  plan                       platform_plans?                  @relation(fields: [plan_id], references: [id])
  setup_status               studio_setup_status?
  subscriptions              subscriptions[]

  // V2.0 Relaciones
  studio_modules            studio_modules[]
  user_studio_roles         user_studio_roles[]
  studio_role_permissions   studio_role_permissions[]
  marketing_pipeline_stages marketing_pipeline_stages[]
  marketing_leads           marketing_leads[]
  manager_pipeline_stages   manager_pipeline_stages[]
  manager_events            manager_events[]
  gantt_templates           gantt_templates[]

  // ZEN Pages Relaciones
  pages                studio_pages?
  portfolios           studio_portfolios[]
  lead_forms           studio_lead_forms[]
  client_portal_access studio_client_portal_access[]

  @@index([plan_id])
  @@index([slug])
  @@index([is_active])
}

model studio_configuraciones {
  id                 String   @id @default(cuid())
  studio_id          String
  nombre             String
  utilidad_servicio  Float
  utilidad_producto  Float
  comision_venta     Float
  sobreprecio        Float
  clave_autorizacion String?
  status             String   @default("active")
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  studio             studios  @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@index([studio_id])
}

model studio_agenda {
  id            String         @id @default(cuid())
  studio_id     String
  userId        String?
  eventoId      String
  concepto      String?
  descripcion   String?
  googleMapsUrl String?
  direccion     String?
  fecha         DateTime?
  hora          String?
  status        String         @default("pendiente")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  agendaTipo    String?
  eventos       studio_eventos @relation(fields: [eventoId], references: [id])
  studio        studios        @relation(fields: [studio_id], references: [id])
  studio_users  studio_users?  @relation(fields: [userId], references: [id])

  @@index([studio_id])
}

model studio_agenda_tipos {
  id        String   @id @default(cuid())
  nombre    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model studio_clientes {
  id                     String                  @id @default(cuid())
  studio_id              String
  platformUserId         String?
  nombre                 String
  email                  String
  telefono               String
  direccion              String?
  status                 String                  @default("activo")
  isActive               Boolean                 @default(true)
  lastLogin              DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  platform_user_profiles platform_user_profiles? @relation(fields: [platformUserId], references: [id])
  studio                 studios                 @relation(fields: [studio_id], references: [id])
  eventos                studio_eventos[]
  pagos                  studio_pagos[]

  @@index([studio_id, email])
  @@index([studio_id, status])
  @@index([studio_id, telefono])
  @@index([platformUserId])
}

model studio_condiciones_comerciales {
  id                                  String                                       @id @default(cuid())
  studio_id                           String
  nombre                              String
  descripcion                         String?
  porcentaje_descuento                Float?
  porcentaje_anticipo                 Float?                                       @default(0)
  status                              String                                       @default("active")
  orden                               Int?                                         @default(0)
  createdAt                           DateTime                                     @default(now())
  updatedAt                           DateTime
  studio                              studios                                      @relation(fields: [studio_id], references: [id])
  condiciones_comerciales_metodo_pago studio_condiciones_comerciales_metodo_pago[]
  cotizaciones                        studio_cotizaciones[]
  pagos                               studio_pagos[]

  @@index([studio_id])
}

model studio_condiciones_comerciales_metodo_pago {
  id                       String                         @id @default(cuid())
  condicionesComercialesId String
  metodoPagoId             String
  orden                    Int?                           @default(0)
  status                   String                         @default("active")
  createdAt                DateTime                       @default(now())
  updatedAt                DateTime
  condiciones_comerciales  studio_condiciones_comerciales @relation(fields: [condicionesComercialesId], references: [id], onDelete: Cascade)
  metodos_pago             studio_metodos_pago            @relation(fields: [metodoPagoId], references: [id])
  pagos                    studio_pagos[]
  cotizaciones             studio_cotizaciones[]          @relation("CondicionesComercialesMetodoPagoToCotizacion")
}

model studio_cotizacion_costos {
  id           String              @id @default(cuid())
  cotizacionId String
  nombre       String
  descripcion  String?
  costo        Float               @default(0)
  tipo         String              @default("adicional")
  posicion     Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime
  cotizaciones studio_cotizaciones @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
}

model studio_cotizacion_servicios {
  id                        String                      @id @default(cuid())
  cotizacionId              String
  servicioId                String?
  servicioCategoriaId       String?
  cantidad                  Int                         @default(1)
  posicion                  Int                         @default(0)
  userId                    String?
  fechaAsignacion           DateTime?
  FechaEntrega              DateTime?
  status                    String                      @default("pendiente")
  seccion_nombre_snapshot   String?
  categoria_nombre_snapshot String?
  nombre_snapshot           String                      @default("Servicio migrado")
  descripcion_snapshot      String?
  precio_unitario_snapshot  Float                       @default(0)
  costo_snapshot            Float                       @default(0)
  gasto_snapshot            Float                       @default(0)
  utilidad_snapshot         Float                       @default(0)
  precio_publico_snapshot   Float                       @default(0)
  tipo_utilidad_snapshot    String                      @default("servicio")
  precioUnitario            Float                       @default(0)
  subtotal                  Float                       @default(0)
  nombre                    String?
  descripcion               String?
  costo                     Float?                      @default(0)
  gasto                     Float?                      @default(0)
  utilidad                  Float?                      @default(0)
  precio_publico            Float?                      @default(0)
  tipo_utilidad             String?                     @default("servicio")
  categoria_nombre          String?
  seccion_nombre            String?
  es_personalizado          Boolean                     @default(false)
  servicio_original_id      String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  cotizaciones              studio_cotizaciones         @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  servicio_categorias       studio_servicio_categorias? @relation(fields: [servicioCategoriaId], references: [id])
  servicios                 studio_servicios?           @relation(fields: [servicioId], references: [id])
  studio_users              studio_users?               @relation(fields: [userId], references: [id])
  nomina_servicios          studio_nomina_servicios[]
}

model studio_cotizacion_visitas {
  id           String              @id @default(cuid())
  cotizacionId String
  createdAt    DateTime            @default(now())
  cotizaciones studio_cotizaciones @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
}

model studio_cotizaciones {
  id                                  String                                       @id @default(cuid())
  studio_id                           String
  eventoTipoId                        String
  eventoId                            String
  nombre                              String
  precio                              Float
  descuento                           Float?
  descripcion                         String?
  condicionesComercialesId            String?
  condicionesComercialesMetodoPagoId  String?
  status                              String                                       @default("pendiente")
  archivada                           Boolean                                      @default(false)
  visible_cliente                     Boolean?                                     @default(true)
  createdAt                           DateTime                                     @default(now())
  updatedAt                           DateTime
  expiresAt                           DateTime?                                    @default(dbgenerated("(now() + '10 days'::interval)"))
  cotizacion_costos                   studio_cotizacion_costos[]
  cotizacion_servicios                studio_cotizacion_servicios[]
  cotizacion_visitas                  studio_cotizacion_visitas[]
  condiciones_comerciales             studio_condiciones_comerciales?              @relation(fields: [condicionesComercialesId], references: [id])
  eventos                             studio_eventos                               @relation(fields: [eventoId], references: [id])
  evento_tipos                        studio_evento_tipos                          @relation(fields: [eventoTipoId], references: [id])
  studio                              studios                                      @relation(fields: [studio_id], references: [id])
  pagos                               studio_pagos[]
  condiciones_comerciales_metodo_pago studio_condiciones_comerciales_metodo_pago[] @relation("CondicionesComercialesMetodoPagoToCotizacion")

  @@index([eventoId])
  @@index([studio_id, status])
}

model studio_evento_bitacoras {
  id          String         @id @default(cuid())
  eventoId    String
  comentario  String
  importancia String         @default("1")
  status      String         @default("active")
  createdAt   DateTime       @default(now())
  updatedAt   DateTime
  eventos     studio_eventos @relation(fields: [eventoId], references: [id])
}

model studio_evento_etapas {
  id        String           @id @default(cuid())
  nombre    String
  orden     Int              @default(0)
  createdAt DateTime         @default(now())
  updatedAt DateTime
  eventos   studio_eventos[]
}

model studio_evento_tipos {
  id           String                @id @default(cuid())
  studio_id    String
  nombre       String
  status       String                @default("active")
  orden        Int                   @default(0)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime
  studio       studios               @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  cotizaciones studio_cotizaciones[]
  eventos      studio_eventos[]
  paquetes     studio_paquetes[]

  // V2.0 Relaciones
  marketing_leads marketing_leads[]
  manager_events  manager_events[]
  gantt_templates gantt_templates[]
}

model studio_eventos {
  id               String                    @id @default(cuid())
  studio_id        String
  clienteId        String
  eventoTipoId     String?
  nombre           String?                   @default("Pendiente")
  fecha_evento     DateTime
  sede             String?
  direccion        String?
  status           String                    @default("active")
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime
  userId           String?
  eventoEtapaId    String?
  agenda           studio_agenda[]
  cotizaciones     studio_cotizaciones[]
  evento_bitacoras studio_evento_bitacoras[]
  clientes         studio_clientes           @relation(fields: [clienteId], references: [id])
  evento_etapas    studio_evento_etapas?     @relation(fields: [eventoEtapaId], references: [id])
  evento_tipos     studio_evento_tipos?      @relation(fields: [eventoTipoId], references: [id])
  studio           studios                   @relation(fields: [studio_id], references: [id])
  studio_users     studio_users?             @relation(fields: [userId], references: [id])
  gastos           studio_gastos[]
  nominas          studio_nominas[]

  @@index([clienteId])
  @@index([fecha_evento])
  @@index([studio_id, status])
}

model studio_gastos {
  id             String          @id @default(cuid())
  studio_id      String
  concepto       String
  descripcion    String?
  monto          Float
  categoria      String
  subcategoria   String?
  fecha          DateTime        @default(now())
  fechaFactura   DateTime?
  status         String          @default("activo")
  metodoPago     String?
  numeroFactura  String?
  proveedor      String?
  eventoId       String?
  usuarioId      String
  comprobanteUrl String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  eventos        studio_eventos? @relation(fields: [eventoId], references: [id])
  studio         studios         @relation(fields: [studio_id], references: [id])
  studio_users   studio_users    @relation(fields: [usuarioId], references: [id])

  @@index([eventoId])
  @@index([fecha, categoria])
  @@index([studio_id])
}

model studio_metodos_pago {
  id                                  String                                       @id @default(cuid())
  studio_id                           String
  metodo_pago                         String
  comision_porcentaje_base            Float?
  comision_fija_monto                 Float?
  num_msi                             Int?
  comision_msi_porcentaje             Float?
  orden                               Int?                                         @default(0)
  payment_method                      String?                                      @default("card")
  status                              String                                       @default("active")
  createdAt                           DateTime                                     @default(now())
  updatedAt                           DateTime
  condiciones_comerciales_metodo_pago studio_condiciones_comerciales_metodo_pago[]
  studio                              studios                                      @relation(fields: [studio_id], references: [id])
  pagos                               studio_pagos[]

  @@index([studio_id])
}

model studio_nomina_servicios {
  id                   String                       @id @default(cuid())
  nominaId             String
  cotizacionServicioId String?
  servicio_nombre      String
  seccion_nombre       String?
  categoria_nombre     String?
  costo_asignado       Float
  cantidad_asignada    Int                          @default(1)
  createdAt            DateTime                     @default(now())
  cotizacion_servicios studio_cotizacion_servicios? @relation(fields: [cotizacionServicioId], references: [id])
  nominas              studio_nominas               @relation(fields: [nominaId], references: [id], onDelete: Cascade)

  @@unique([nominaId, cotizacionServicioId])
}

model studio_nominas {
  id                                                String                    @id @default(cuid())
  studio_id                                         String
  userId                                            String
  eventoId                                          String?
  concepto                                          String
  descripcion                                       String?
  monto_bruto                                       Float
  deducciones                                       Float                     @default(0)
  monto_neto                                        Float
  tipo_pago                                         String                    @default("individual")
  servicios_incluidos                               Int                       @default(1)
  fecha_asignacion                                  DateTime                  @default(now())
  fecha_autorizacion                                DateTime?
  fecha_pago                                        DateTime?
  periodo_inicio                                    DateTime?
  periodo_fin                                       DateTime?
  status                                            String                    @default("pendiente")
  autorizado_por                                    String?
  pagado_por                                        String?
  metodo_pago                                       String?                   @default("transferencia")
  costo_total_snapshot                              Float                     @default(0)
  gasto_total_snapshot                              Float                     @default(0)
  comision_porcentaje                               Float?
  createdAt                                         DateTime                  @default(now())
  updatedAt                                         DateTime
  personalId                                        String?
  nomina_servicios                                  studio_nomina_servicios[]
  studio_users_nominas_autorizado_porTostudio_users studio_users?             @relation("nominas_autorizado_porTostudio_users", fields: [autorizado_por], references: [id])
  eventos                                           studio_eventos?           @relation(fields: [eventoId], references: [id])
  studio_users_nominas_pagado_porTostudio_users     studio_users?             @relation("nominas_pagado_porTostudio_users", fields: [pagado_por], references: [id])
  personal                                          studio_personal?          @relation(fields: [personalId], references: [id])
  studio                                            studios                   @relation(fields: [studio_id], references: [id])
  studio_users_nominas_userIdTostudio_users         studio_users              @relation("nominas_userIdTostudio_users", fields: [userId], references: [id])

  @@index([studio_id])
}

model studio_pagos {
  id                                  String                                      @id @default(cuid())
  clienteId                           String?
  cotizacionId                        String?
  condicionesComercialesId            String?
  condicionesComercialesMetodoPagoId  String?
  metodoPagoId                        String?
  metodo_pago                         String
  monto                               Float
  comisionStripe                      Float?
  concepto                            String
  descripcion                         String?
  stripe_session_id                   String?                                     @unique
  stripe_payment_id                   String?                                     @unique
  status                              String                                      @default("pending")
  createdAt                           DateTime                                    @default(now())
  updatedAt                           DateTime
  userId                              String?
  tipo_transaccion                    String?                                     @default("ingreso")
  categoria_transaccion               String?                                     @default("abono")
  clientes                            studio_clientes?                            @relation(fields: [clienteId], references: [id])
  condiciones_comerciales             studio_condiciones_comerciales?             @relation(fields: [condicionesComercialesId], references: [id])
  condiciones_comerciales_metodo_pago studio_condiciones_comerciales_metodo_pago? @relation(fields: [condicionesComercialesMetodoPagoId], references: [id])
  cotizaciones                        studio_cotizaciones?                        @relation(fields: [cotizacionId], references: [id])
  metodos_pago                        studio_metodos_pago?                        @relation(fields: [metodoPagoId], references: [id])
  studio_users                        studio_users?                               @relation(fields: [userId], references: [id])
}

model studio_paquete_servicios {
  id                  String                     @id @default(cuid())
  paqueteId           String
  servicioId          String
  servicioCategoriaId String
  cantidad            Int                        @default(1)
  posicion            Int                        @default(0)
  visible_cliente     Boolean                    @default(true)
  status              String                     @default("active")
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime
  paquetes            studio_paquetes            @relation(fields: [paqueteId], references: [id], onDelete: Cascade)
  servicio_categorias studio_servicio_categorias @relation(fields: [servicioCategoriaId], references: [id])
  servicios           studio_servicios           @relation(fields: [servicioId], references: [id])
}

model studio_paquetes {
  id                String                     @id @default(cuid())
  studio_id         String
  eventoTipoId      String
  nombre            String
  costo             Float?
  gasto             Float?
  utilidad          Float?
  precio            Float?
  status            String                     @default("active")
  posicion          Int                        @default(0)
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime
  paquete_servicios studio_paquete_servicios[]
  evento_tipos      studio_evento_tipos        @relation(fields: [eventoTipoId], references: [id])
  studio            studios                    @relation(fields: [studio_id], references: [id])

  @@index([studio_id, status])
}

model studio_revenue_products {
  id                      String                           @id @default(cuid())
  nombre                  String
  descripcion             String
  categoria               String
  precioPublico           Decimal
  comisionProsocial       Decimal
  comisionStudio          Decimal
  tipoFacturacion         String
  cicloVida               Int?
  activo                  Boolean                          @default(true)
  configuracion           Json?
  createdAt               DateTime                         @default(now())
  updatedAt               DateTime
  studio_revenue_products studio_studio_revenue_products[]

  @@index([categoria, activo])
}

model studio_revenue_transactions {
  id                   String   @id @default(cuid())
  studio_id            String
  payment_id           String
  amount_total         Decimal
  prosocial_commission Decimal
  studio_amount        Decimal
  commission_rate      Decimal
  description          String?
  transaction_date     DateTime @default(now())
  status               String   @default("pending")
  stripe_transfer_id   String?
  stripe_fee           Decimal?
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
  studio               studios  @relation(fields: [studio_id], references: [id])

  @@index([status])
  @@index([studio_id, transaction_date])
}

model studio_seccion_categorias {
  id                  String                     @id @default(cuid())
  seccionId           String
  categoriaId         String                     @unique
  servicio_categorias studio_servicio_categorias @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  servicio_secciones  studio_servicio_secciones  @relation(fields: [seccionId], references: [id], onDelete: Cascade)
}

model studio_servicio_categorias {
  id                   String                        @id @default(cuid())
  nombre               String                        @unique
  orden                Int                           @default(0)
  createdAt            DateTime                      @default(now())
  updatedAt            DateTime                      @updatedAt
  cotizacion_servicios studio_cotizacion_servicios[]
  paquete_servicios    studio_paquete_servicios[]
  seccion_categorias   studio_seccion_categorias?
  servicios            studio_servicios[]
}

model studio_servicio_gastos {
  id         String           @id @default(cuid())
  servicioId String
  nombre     String
  costo      Float
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  servicios  studio_servicios @relation(fields: [servicioId], references: [id], onDelete: Cascade)
}

model studio_servicio_secciones {
  id                 String                      @id @default(cuid())
  nombre             String                      @unique
  descripcion        String?
  orden              Int                         @default(0)
  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
  seccion_categorias studio_seccion_categorias[]
}

model studio_servicios {
  id                   String                        @id @default(cuid())
  studioId             String
  servicioCategoriaId  String
  nombre               String
  costo                Float                         @default(0)
  gasto                Float                         @default(0)
  tipo_utilidad        String                        @default("servicio")
  orden                Int                           @default(0)
  status               String                        @default("active")
  createdAt            DateTime                      @default(now())
  updatedAt            DateTime                      @updatedAt
  cotizacion_servicios studio_cotizacion_servicios[]
  paquete_servicios    studio_paquete_servicios[]
  servicio_gastos      studio_servicio_gastos[]
  studio               studios                       @relation(fields: [studioId], references: [id], map: "studio_servicios_studio_id_fkey")
  servicio_categorias  studio_servicio_categorias    @relation(fields: [servicioCategoriaId], references: [id])

  @@index([studioId, status], map: "studio_servicios_studio_id_status_idx")
  @@index([studioId, status])
}

// NOTA: utilidad y precio_publico se eliminaron - se calculan al vuelo con studio_configuraciones
// Solo se almacenan: costo, gasto, tipo_utilidad
// En cotizaciones SÍ se congelan todos los valores

model studio_studio_revenue_products {
  id                  String                  @id @default(cuid())
  studio_id           String
  revenueProductId    String
  activo              Boolean                 @default(false)
  precioCustom        Decimal?
  comisionCustom      Decimal?
  configuracionStudio Json?
  activadoEn          DateTime?
  desactivadoEn       DateTime?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime
  studio              studios                 @relation(fields: [studio_id], references: [id])
  revenue_products    studio_revenue_products @relation(fields: [revenueProductId], references: [id])

  @@unique([studio_id, revenueProductId])
  @@index([studio_id, activo])
}

model studio_users {
  id                                           String                        @id @default(cuid())
  studio_id                                    String
  platformUserId                               String?
  fullName                                     String
  phone                                        String?
  type                                         PersonnelType
  role                                         String                        @default("user")
  status                                       String                        @default("inactive")
  isActive                                     Boolean                       @default(true)
  createdAt                                    DateTime                      @default(now())
  updatedAt                                    DateTime                      @updatedAt
  agenda                                       studio_agenda[]
  cotizacion_servicios                         studio_cotizacion_servicios[]
  eventos                                      studio_eventos[]
  gastos                                       studio_gastos[]
  nominas_nominas_autorizado_porTostudio_users studio_nominas[]              @relation("nominas_autorizado_porTostudio_users")
  nominas_nominas_pagado_porTostudio_users     studio_nominas[]              @relation("nominas_pagado_porTostudio_users")
  nominas_nominas_userIdTostudio_users         studio_nominas[]              @relation("nominas_userIdTostudio_users")
  pagos                                        studio_pagos[]
  platform_user_profiles                       platform_user_profiles?       @relation(fields: [platformUserId], references: [id])
  studio                                       studios                       @relation(fields: [studio_id], references: [id])

  @@index([studio_id, status])
  @@index([type])
  @@index([isActive])
  @@index([platformUserId])
}

model platform_user_profiles {
  id              String            @id @default(cuid())
  supabaseUserId  String?           @unique
  email           String            @unique
  role            UserRole
  fullName        String?
  avatarUrl       String?
  isActive        Boolean           @default(true)
  studio_id       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  studio          studios?          @relation(fields: [studio_id], references: [id])
  studio_clientes studio_clientes[]
  studio_personal studio_personal[]
  studio_users    studio_users[]

  @@index([email])
  @@index([role])
  @@index([studio_id])
  @@index([supabaseUserId])
}

model studio_user_profiles {
  id                     String                   @id @default(cuid())
  email                  String                   @unique
  fullName               String?
  avatarUrl              String?
  role                   UserRole
  studio_id              String?
  isActive               Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  platform_activities    platform_activities[]
  platform_lead_bitacora platform_lead_bitacora[]
  platform_notifications platform_notifications[]
  studio                 studios?                 @relation(fields: [studio_id], references: [id])

  @@index([email])
  @@index([role])
  @@index([studio_id])
}

model subscriptions {
  id                     String                          @id @default(cuid())
  studio_id              String
  stripe_subscription_id String                          @unique
  stripe_customer_id     String
  plan_id                String
  status                 SubscriptionStatus
  current_period_start   DateTime
  current_period_end     DateTime
  billing_cycle_anchor   DateTime
  created_at             DateTime                        @default(now())
  updated_at             DateTime
  agent_discount_codes   platform_agent_discount_codes[]
  billing_cycles         platform_billing_cycles[]
  discount_usage         platform_discount_usage[]
  plans                  platform_plans                  @relation(fields: [plan_id], references: [id])
  studio                 studios                         @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([stripe_subscription_id])
  @@index([studio_id])
}

model plan_services {
  id         String            @id @default(cuid())
  plan_id    String
  service_id String
  active     Boolean           @default(false)
  limite     Int?
  unidad     UnidadMedida?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  plan       platform_plans    @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  service    platform_services @relation(fields: [service_id], references: [id], onDelete: Cascade)

  @@unique([plan_id, service_id])
  @@index([plan_id])
  @@index([service_id])
}

model service_categories {
  id          String              @id @default(cuid())
  name        String              @unique
  description String
  icon        String
  posicion    Int                 @default(0)
  active      Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  services    platform_services[]

  @@index([active, posicion])
}

model studio_telefonos {
  id        String   @id @default(cuid())
  studio_id String
  numero    String
  tipo      String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  order     Int      @default(0)
  studio    studios  @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@index([studio_id])
  @@index([studio_id, activo])
}

model studio_horarios_atencion {
  id          String   @id @default(cuid())
  studio_id   String
  dia_semana  String
  hora_inicio String
  hora_fin    String
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  studio      studios  @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@unique([studio_id, dia_semana])
  @@index([studio_id])
  @@index([studio_id, dia_semana])
}

model platform_social_networks {
  id                    String                  @id @default(cuid())
  name                  String                  @unique
  slug                  String                  @unique
  description           String?
  color                 String?
  icon                  String?
  baseUrl               String?
  order                 Int                     @default(0)
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  studio_redes_sociales studio_redes_sociales[]

  @@index([isActive])
  @@index([order])
}

model studio_redes_sociales {
  id           String                    @id @default(cuid())
  studio_id    String
  plataformaId String?
  url          String
  activo       Boolean                   @default(true)
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  order        Int                       @default(0)
  plataforma   platform_social_networks? @relation(fields: [plataformaId], references: [id])
  studio       studios                   @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@unique([studio_id, plataformaId])
  @@index([studio_id])
  @@index([plataformaId])
}

model studio_cuentas_bancarias {
  id           String   @id @default(cuid())
  studio_id    String
  banco        String
  numeroCuenta String
  tipoCuenta   String
  titular      String
  activo       Boolean  @default(true)
  esPrincipal  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  studio       studios  @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@index([studio_id])
  @@index([activo])
  @@index([esPrincipal])
}

model studio_setup_status {
  id                String                   @id @default(cuid())
  studio_id         String                   @unique
  overallProgress   Int                      @default(0)
  isFullyConfigured Boolean                  @default(false)
  lastValidatedAt   DateTime                 @default(now())
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  sections          setup_section_progress[]
  studio            studios                  @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@index([studio_id])
  @@index([isFullyConfigured])
  @@index([overallProgress])
}

model setup_section_progress {
  id                   String              @id @default(cuid())
  setupStatusId        String
  sectionId            String
  sectionName          String
  status               String
  completionPercentage Int                 @default(0)
  completedFields      Json
  missingFields        Json
  errors               Json?
  completedAt          DateTime?
  lastUpdatedAt        DateTime            @default(now())
  setupStatus          studio_setup_status @relation(fields: [setupStatusId], references: [id], onDelete: Cascade)

  @@unique([setupStatusId, sectionId])
  @@index([sectionId])
  @@index([status])
  @@index([completionPercentage])
}

model setup_section_config {
  id             String   @id @default(cuid())
  sectionId      String   @unique
  sectionName    String
  description    String
  requiredFields Json
  optionalFields Json
  dependencies   Json
  weight         Int      @default(10)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([sectionId])
  @@index([isActive])
}

model setup_progress_log {
  id        String   @id @default(cuid())
  studio_id String
  sectionId String?
  action    String
  oldStatus String?
  newStatus String?
  details   Json?
  source    String
  createdAt DateTime @default(now())

  @@index([studio_id])
  @@index([sectionId])
  @@index([action])
  @@index([createdAt])
}

model studio_reglas_agendamiento {
  id                 String   @id @default(cuid())
  studio_id          String
  nombre             String
  descripcion        String?
  recurrencia        String
  capacidadOperativa Int      @default(1)
  status             String   @default("active")
  orden              Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  studio             studios  @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@index([studio_id])
  @@index([status])
  @@index([orden])
}

model studio_personal {
  id                   String                                @id @default(cuid())
  studio_id            String
  nombre               String
  email                String?
  telefono             String?
  tipo                 PersonalType
  categoriaId          String
  status               String                                @default("activo")
  platformUserId       String?
  honorarios_fijos     Float?
  honorarios_variables Float?
  createdAt            DateTime                              @default(now())
  updatedAt            DateTime                              @updatedAt
  cuenta_clabe         String?
  telefono_emergencia  String?
  orden                Int?
  nominas              studio_nominas[]
  categoria            studio_categorias_personal            @relation(fields: [categoriaId], references: [id])
  platformUser         platform_user_profiles?               @relation(fields: [platformUserId], references: [id])
  studio               studios                               @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  profile_assignments  studio_personal_profile_assignments[]

  @@index([telefono_emergencia])
  @@index([cuenta_clabe])
  @@index([studio_id])
  @@index([tipo])
  @@index([status])
  @@index([platformUserId])
}

model studio_categorias_personal {
  id          String            @id @default(cuid())
  studio_id   String
  nombre      String
  descripcion String?
  tipo        PersonalType
  color       String?
  icono       String?
  esDefault   Boolean           @default(false)
  orden       Int               @default(0)
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  studio      studios           @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  personal    studio_personal[]

  @@unique([studio_id, nombre])
  @@index([studio_id, tipo])
  @@index([studio_id, isActive])
  @@index([esDefault])
  @@index([orden])
}

model studio_personal_profiles {
  id                   String                                @id @default(cuid())
  studio_id            String
  nombre               String
  descripcion          String?
  orden                Int                                   @default(0)
  isActive             Boolean                               @default(true)
  createdAt            DateTime                              @default(now())
  updatedAt            DateTime                              @updatedAt
  personal_assignments studio_personal_profile_assignments[]
  studio               studios                               @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@unique([studio_id, nombre])
  @@index([studio_id, isActive])
  @@index([orden])
}

model studio_personal_profile_assignments {
  id         String                   @id @default(cuid())
  personalId String
  profileId  String
  createdAt  DateTime                 @default(now())
  personal   studio_personal          @relation(fields: [personalId], references: [id], onDelete: Cascade)
  profile    studio_personal_profiles @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([personalId, profileId])
  @@index([personalId])
  @@index([profileId])
}

enum PlatformLeadBitacoraTipo {
  NOTA_PERSONALIZADA
  CAMBIO_ETAPA
  ASIGNACION_AGENTE
  DESASIGNACION_AGENTE
  CREACION_LEAD
  ACTUALIZACION_DATOS
  LLAMADA_REALIZADA
  EMAIL_ENVIADO
  REUNION_AGENDADA
  CONTRATO_FIRMADO
  SUSCRIPCION_ACTIVA
  CANCELACION
  DESCUENTO_APLICADO
  CODIGO_DESCUENTO_GENERADO
}

enum UnidadMedida {
  BOOLEAN
  CANTIDAD
  HORAS
  USUARIOS
  CATALOGOS
  GB
  PROYECTOS
  COTIZACIONES
  LANDING_PAGES
}

enum UserRole {
  SUPER_ADMIN
  AGENTE
  SUSCRIPTOR
  PERSONAL_SUSCRIPTOR
  CLIENTE_SUSCRIPTOR
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELLED
  PAUSED
  EXPIRED
}

enum LeadStatus {
  NUEVO
  CONTACTADO
  INTERESADO
  COTIZACION
  NEGOCIACION
  CONVERTIDO
  PERDIDO
}

enum PersonnelType {
  EMPLEADO
  PROVEEDOR
}

enum PersonalType {
  OPERATIVO
  ADMINISTRATIVO
  PROVEEDOR
}

// ============================================
// ARQUITECTURA V2.0 - NUEVOS MODELOS
// ============================================

// ---------------------------------------------
// 1. SISTEMA DE MÓDULOS
// ---------------------------------------------

model platform_modules {
  id           String         @id @default(cuid())
  slug         String         @unique // "manager", "magic", "marketing", "payment", "cloud"
  name         String // "ZEN Manager", "ZEN Magic", etc.
  description  String?
  category     ModuleCategory // CORE, ADDON, ENTERPRISE
  base_price   Decimal? // NULL para CORE, precio para ADDON
  billing_type String         @default("MONTHLY") // MONTHLY, YEARLY, ONE_TIME
  is_active    Boolean        @default(true)
  version      String         @default("1.0.0")
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt

  studio_modules studio_modules[]

  @@index([category, is_active])
}

model studio_modules {
  id             String    @id @default(cuid())
  studio_id      String
  module_id      String
  is_active      Boolean   @default(false)
  activated_at   DateTime?
  deactivated_at DateTime?
  config_data    Json? // Configuración específica del módulo por studio
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  studio studios          @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  module platform_modules @relation(fields: [module_id], references: [id])

  @@unique([studio_id, module_id])
  @@index([studio_id, is_active])
  @@index([module_id, is_active])
}

enum ModuleCategory {
  CORE // Incluido en plan
  ADDON // Pago adicional
  ENTERPRISE // Solo enterprise
}

// ---------------------------------------------
// 2. USUARIOS MULTI-CONTEXTO
// ---------------------------------------------

model users {
  id             String   @id @default(cuid())
  supabase_id    String   @unique // Auth UUID de Supabase
  email          String   @unique
  full_name      String?
  avatar_url     String?
  phone          String?
  is_active      Boolean  @default(true)
  email_verified Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  platform_roles user_platform_roles[]
  studio_roles   user_studio_roles[]

  @@index([email])
  @@index([supabase_id])
  @@index([is_active])
}

model user_platform_roles {
  id         String       @id @default(cuid())
  user_id    String
  role       PlatformRole
  is_active  Boolean      @default(true)
  granted_at DateTime     @default(now())
  granted_by String? // user_id de quien otorgó
  revoked_at DateTime?

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, role])
  @@index([user_id, is_active])
  @@index([role, is_active])
}

model user_studio_roles {
  id          String     @id @default(cuid())
  user_id     String
  studio_id   String
  role        StudioRole
  permissions Json? // Permisos granulares específicos
  is_active   Boolean    @default(true)
  invited_at  DateTime   @default(now())
  invited_by  String? // user_id de quien invitó
  accepted_at DateTime?
  revoked_at  DateTime?

  user   users   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  studio studios @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  // Relaciones inversas para Gantt
  assigned_tasks_gantt  gantt_event_tasks[]   @relation("TaskAssignedTo")
  completed_tasks_gantt gantt_event_tasks[]   @relation("TaskCompletedBy")
  gantt_task_activities gantt_task_activity[]

  // Relaciones inversas para Marketing
  assigned_leads  marketing_leads[]
  lead_activities marketing_lead_activities[]
  lead_notes      marketing_lead_notes[]

  // Relaciones inversas para Manager
  managed_events manager_events[]         @relation("EventProjectManager")
  client_events  manager_events[]         @relation("EventClient")
  event_tasks    manager_event_tasks[]
  event_team     manager_event_team[]
  event_timeline manager_event_timeline[]

  @@unique([user_id, studio_id, role])
  @@index([user_id, is_active])
  @@index([studio_id, is_active])
  @@index([role, is_active])
  @@index([user_id, studio_id, is_active])
}

model studio_role_permissions {
  id          String     @id @default(cuid())
  studio_id   String
  role        StudioRole
  module_slug String // "manager", "payment", "marketing"
  permissions Json // { "create": true, "read": true, "update": false, "delete": false }
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  studio studios @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@unique([studio_id, role, module_slug])
  @@index([studio_id, role])
}

enum PlatformRole {
  SUPER_ADMIN // Administrador de la plataforma
  AGENTE // Agente de ventas/soporte
  SUSCRIPTOR // Dueño de un studio
}

enum StudioRole {
  OWNER // Dueño del studio (acceso total)
  ADMIN // Administrador (casi acceso total)
  MANAGER // Gerente (gestión operativa)
  PHOTOGRAPHER // Fotógrafo (personal operativo)
  EDITOR // Editor (personal operativo)
  ASSISTANT // Asistente (personal operativo)
  PROVIDER // Proveedor externo (acceso limitado)
  CLIENT // Cliente final (acceso a portal)
}

// ---------------------------------------------
// 3. PIPELINES DUALES - MARKETING (CRM)
// ---------------------------------------------

model marketing_pipeline_stages {
  id          String             @id @default(cuid())
  studio_id   String
  name        String // "Lead Nuevo", "Contactado", etc.
  slug        String // "lead_nuevo", "contactado"
  description String?
  color       String             @default("#3B82F6")
  order       Int                @default(0)
  stage_type  MarketingStageType
  is_active   Boolean            @default(true)
  is_system   Boolean            @default(false) // No editable
  created_at  DateTime           @default(now())
  updated_at  DateTime           @updatedAt

  studio studios           @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  leads  marketing_leads[]

  @@unique([studio_id, slug])
  @@index([studio_id, is_active, order])
}

model marketing_leads {
  id                    String       @id @default(cuid())
  studio_id             String
  stage_id              String
  contact_name          String
  contact_email         String
  contact_phone         String
  event_type_id         String?
  event_date            DateTime?
  budget_range          String?
  source_channel_id     String?
  assigned_to_user_id   String?
  priority              LeadPriority @default(MEDIUM)
  score                 Int?
  last_contact_date     DateTime?
  next_follow_up_date   DateTime?
  contact_attempts      Int          @default(0)
  converted_to_event_id String?      @unique
  converted_at          DateTime?
  conversion_value      Decimal?
  is_active             Boolean      @default(true)
  lost_reason           String?
  lost_at               DateTime?
  created_at            DateTime     @default(now())
  updated_at            DateTime     @updatedAt

  studio          studios                   @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  stage           marketing_pipeline_stages @relation(fields: [stage_id], references: [id])
  event_type      studio_evento_tipos?      @relation(fields: [event_type_id], references: [id])
  assigned_to     user_studio_roles?        @relation(fields: [assigned_to_user_id], references: [id])
  converted_event manager_events?

  activities marketing_lead_activities[]
  quotes     marketing_quotes[]
  notes      marketing_lead_notes[]

  @@index([studio_id, stage_id])
  @@index([studio_id, is_active])
  @@index([assigned_to_user_id])
  @@index([converted_to_event_id])
  @@index([event_date])
}

model marketing_lead_activities {
  id           String       @id @default(cuid())
  lead_id      String
  user_id      String
  type         ActivityType
  subject      String
  description  String?
  outcome      String?
  scheduled_at DateTime?
  completed_at DateTime?
  created_at   DateTime     @default(now())

  lead marketing_leads   @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  user user_studio_roles @relation(fields: [user_id], references: [id])

  @@index([lead_id, created_at])
}

model marketing_quotes {
  id               String    @id @default(cuid())
  lead_id          String
  version          Int       @default(1)
  quote_data       Json
  total_amount     Decimal
  discount_percent Decimal?  @default(0)
  final_amount     Decimal
  sent_at          DateTime?
  viewed_at        DateTime?
  view_count       Int       @default(0)
  accepted_at      DateTime?
  rejected_at      DateTime?
  rejection_reason String?
  expires_at       DateTime
  is_active        Boolean   @default(true)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  lead marketing_leads @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  @@index([lead_id, version])
  @@index([expires_at, is_active])
}

model marketing_lead_notes {
  id         String   @id @default(cuid())
  lead_id    String
  user_id    String
  content    String
  is_pinned  Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  lead marketing_leads   @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  user user_studio_roles @relation(fields: [user_id], references: [id])

  @@index([lead_id, created_at])
}

enum MarketingStageType {
  PROSPECTING // Prospección
  QUALIFICATION // Calificación
  PROPOSAL // Propuesta
  CONVERSION // Ganado
  CLOSED_LOST // Perdido
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  WHATSAPP
  NOTE
  TASK
}

// ---------------------------------------------
// 4. PIPELINES DUALES - MANAGER (Operacional)
// ---------------------------------------------

model manager_pipeline_stages {
  id          String           @id @default(cuid())
  studio_id   String
  name        String // "Planeación", "Producción", etc.
  slug        String // "planeacion", "produccion"
  description String?
  color       String           @default("#10B981")
  order       Int              @default(0)
  stage_type  ManagerStageType
  is_active   Boolean          @default(true)
  is_system   Boolean          @default(false)
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt

  studio studios          @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  events manager_events[]

  @@unique([studio_id, slug])
  @@index([studio_id, is_active, order])
}

model manager_events {
  id                      String    @id @default(cuid())
  studio_id               String
  stage_id                String
  client_id               String // user_studio_roles con role CLIENT
  event_type_id           String
  event_name              String
  event_date              DateTime
  venue_name              String?
  venue_address           String?
  studio_manager_id       String?
  contract_value          Decimal
  paid_amount             Decimal   @default(0)
  pending_amount          Decimal   @default(0)
  started_at              DateTime?
  completed_at            DateTime?
  originated_from_lead_id String?   @unique
  is_active               Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  studio          studios                 @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  stage           manager_pipeline_stages @relation(fields: [stage_id], references: [id])
  client          user_studio_roles       @relation("EventClient", fields: [client_id], references: [id])
  event_type      studio_evento_tipos     @relation(fields: [event_type_id], references: [id])
  project_manager user_studio_roles?      @relation("EventProjectManager", fields: [studio_manager_id], references: [id])
  originated_lead marketing_leads?        @relation(fields: [originated_from_lead_id], references: [id])

  gantt                       gantt_event_instances?
  tasks                       manager_event_tasks[]
  deliverables                manager_event_deliverables[]
  team_assignments            manager_event_team[]
  timeline                    manager_event_timeline[]
  payments                    manager_event_payments[]
  studio_client_portal_access studio_client_portal_access[]

  @@index([studio_id, stage_id])
  @@index([event_date])
  @@index([client_id])
  @@index([originated_from_lead_id])
}

model manager_event_tasks {
  id             String    @id @default(cuid())
  event_id       String
  title          String
  description    String?
  assigned_to_id String?
  due_date       DateTime?
  completed_at   DateTime?
  is_completed   Boolean   @default(false)
  order          Int       @default(0)
  created_at     DateTime  @default(now())

  event       manager_events     @relation(fields: [event_id], references: [id], onDelete: Cascade)
  assigned_to user_studio_roles? @relation(fields: [assigned_to_id], references: [id])

  @@index([event_id, is_completed])
}

model manager_event_deliverables {
  id                 String          @id @default(cuid())
  event_id           String
  type               DeliverableType
  name               String
  description        String?
  file_url           String?
  file_size_mb       Float?
  delivered_at       DateTime?
  client_approved_at DateTime?
  created_at         DateTime        @default(now())

  event manager_events @relation(fields: [event_id], references: [id], onDelete: Cascade)

  @@index([event_id, type])
}

model manager_event_team {
  id         String   @id @default(cuid())
  event_id   String
  user_id    String
  role       String // "Fotógrafo Principal", "Editor", etc.
  hours      Float?
  cost       Decimal?
  created_at DateTime @default(now())

  event manager_events    @relation(fields: [event_id], references: [id], onDelete: Cascade)
  user  user_studio_roles @relation(fields: [user_id], references: [id])

  @@unique([event_id, user_id, role])
  @@index([event_id])
}

model manager_event_timeline {
  id          String   @id @default(cuid())
  event_id    String
  user_id     String?
  action_type String // "stage_changed", "payment_received", etc.
  description String
  metadata    Json?
  created_at  DateTime @default(now())

  event manager_events     @relation(fields: [event_id], references: [id], onDelete: Cascade)
  user  user_studio_roles? @relation(fields: [user_id], references: [id])

  @@index([event_id, created_at])
}

model manager_event_payments {
  id                String   @id @default(cuid())
  event_id          String
  amount            Decimal
  payment_method    String
  payment_date      DateTime
  concept           String?
  stripe_payment_id String?  @unique
  created_at        DateTime @default(now())

  event manager_events @relation(fields: [event_id], references: [id], onDelete: Cascade)

  @@index([event_id, payment_date])
}

enum ManagerStageType {
  PLANNING // Planeación pre-evento
  PRODUCTION // Día del evento
  POST_PRODUCTION // Edición, revisión
  DELIVERY // Entrega al cliente
  WARRANTY // Período de garantía
  COMPLETED // Proyecto cerrado
}

enum DeliverableType {
  PHOTO_GALLERY
  VIDEO_HIGHLIGHTS
  FULL_VIDEO
  ALBUM
  DIGITAL_DOWNLOAD
  OTHER
}

// ---------------------------------------------
// 5. SISTEMA GANTT TEMPLATES
// ---------------------------------------------

model gantt_templates {
  id                      String   @id @default(cuid())
  studio_id               String
  name                    String // "Boda Standard"
  description             String?
  event_type_id           String?
  estimated_duration_days Int // 45 días total
  pre_event_days          Int // 30 días antes
  post_event_days         Int // 15 días después
  color                   String   @default("#3B82F6")
  icon                    String?
  is_default              Boolean  @default(false)
  is_active               Boolean  @default(true)
  created_by_user_id      String
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  studio     studios              @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  event_type studio_evento_tipos? @relation(fields: [event_type_id], references: [id])

  tasks     gantt_template_tasks[]
  instances gantt_event_instances[]

  @@unique([studio_id, name])
  @@index([studio_id, is_active])
  @@index([event_type_id])
}

model gantt_template_tasks {
  id                 String       @id @default(cuid())
  template_id        String
  name               String
  description        String?
  days_before_event  Int? // Días antes del evento
  days_after_event   Int? // Días después del evento
  duration_days      Int          @default(1)
  category           TaskCategory
  priority           TaskPriority @default(MEDIUM)
  depends_on_task_id String?
  suggested_role     String? // "PHOTOGRAPHER", "EDITOR"
  order              Int          @default(0)
  checklist_items    Json?
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt

  template        gantt_templates        @relation(fields: [template_id], references: [id], onDelete: Cascade)
  depends_on      gantt_template_tasks?  @relation("TaskDependency", fields: [depends_on_task_id], references: [id])
  dependent_tasks gantt_template_tasks[] @relation("TaskDependency")

  @@index([template_id, order])
  @@index([category])
}

model gantt_event_instances {
  id          String   @id @default(cuid())
  event_id    String   @unique
  template_id String?
  is_custom   Boolean  @default(false)
  custom_name String?
  event_date  DateTime // Fecha del evento (ancla)
  start_date  DateTime // Primera tarea
  end_date    DateTime // Última tarea
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  event    manager_events   @relation(fields: [event_id], references: [id], onDelete: Cascade)
  template gantt_templates? @relation(fields: [template_id], references: [id])

  tasks gantt_event_tasks[]

  @@index([event_id])
  @@index([template_id])
}

model gantt_event_tasks {
  id                   String       @id @default(cuid())
  gantt_instance_id    String
  template_task_id     String?
  name                 String
  description          String?
  start_date           DateTime
  end_date             DateTime
  duration_days        Int          @default(1)
  category             TaskCategory
  priority             TaskPriority @default(MEDIUM)
  assigned_to_user_id  String?
  assigned_at          DateTime?
  status               TaskStatus   @default(PENDING)
  progress_percent     Int          @default(0)
  completed_at         DateTime?
  completed_by_user_id String?
  depends_on_task_id   String?
  checklist_items      Json?
  order                Int          @default(0)
  notes                String?
  created_at           DateTime     @default(now())
  updated_at           DateTime     @updatedAt

  gantt_instance  gantt_event_instances @relation(fields: [gantt_instance_id], references: [id], onDelete: Cascade)
  assigned_to     user_studio_roles?    @relation("TaskAssignedTo", fields: [assigned_to_user_id], references: [id])
  completed_by    user_studio_roles?    @relation("TaskCompletedBy", fields: [completed_by_user_id], references: [id])
  depends_on      gantt_event_tasks?    @relation("EventTaskDependency", fields: [depends_on_task_id], references: [id])
  dependent_tasks gantt_event_tasks[]   @relation("EventTaskDependency")

  activity_log gantt_task_activity[]

  @@index([gantt_instance_id, status])
  @@index([assigned_to_user_id])
  @@index([start_date, end_date])
}

model gantt_task_activity {
  id         String     @id @default(cuid())
  task_id    String
  user_id    String
  action     TaskAction
  old_value  Json?
  new_value  Json?
  notes      String?
  created_at DateTime   @default(now())

  task gantt_event_tasks @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user user_studio_roles @relation(fields: [user_id], references: [id])

  @@index([task_id, created_at])
}

enum TaskCategory {
  PLANNING
  PRODUCTION
  POST_PRODUCTION
  REVIEW
  DELIVERY
  WARRANTY
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}

enum TaskAction {
  CREATED
  UPDATED
  ASSIGNED
  STATUS_CHANGED
  COMPLETED
  DELETED
  NOTE_ADDED
}

// ---------------------------------------------
// 6. ZEN PAGES - LANDING PÚBLICA DEL STUDIO
// ---------------------------------------------

model studio_pages {
  id               String   @id @default(cuid())
  studio_id        String   @unique
  is_published     Boolean  @default(false)
  custom_domain    String?  @unique // futuro: estudio.com
  meta_title       String?
  meta_description String?
  meta_keywords    String?
  favicon_url      String?
  og_image_url     String? // Open Graph para redes sociales
  analytics_code   String? // Google Analytics
  theme_color      String?  @default("#8B5CF6") // Color principal
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  studio     studios                @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  sections   studio_page_sections[]
  portfolios studio_portfolios[]

  @@index([studio_id, is_published])
}

model studio_page_sections {
  id           String          @id @default(cuid())
  page_id      String
  section_type PageSectionType // HERO, ABOUT, CTA, etc.
  title        String?
  subtitle     String?
  content      String? // Texto rico o markdown
  image_url    String?
  video_url    String?
  cta_text     String?
  cta_link     String?
  order        Int             @default(0)
  is_visible   Boolean         @default(true)
  settings     Json? // Configuración específica (colores, layout)
  created_at   DateTime        @default(now())
  updated_at   DateTime        @updatedAt

  page studio_pages @relation(fields: [page_id], references: [id], onDelete: Cascade)

  @@index([page_id, order])
}

enum PageSectionType {
  HERO // Sección principal con imagen y CTA
  ABOUT // Sobre nosotros
  SERVICES // Servicios destacados
  CTA // Call to action
  TESTIMONIALS // Testimonios de clientes
  FAQ // Preguntas frecuentes
  CUSTOM // Sección personalizada
}

model studio_portfolios {
  id              String   @id @default(cuid())
  page_id         String
  studio_id       String
  title           String
  slug            String // URL-friendly (ej: "bodas-2024")
  description     String?
  cover_image_url String?
  category        String? // "Bodas", "XV Años", "Empresarial"
  order           Int      @default(0)
  is_published    Boolean  @default(false)
  view_count      Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  page   studio_pages             @relation(fields: [page_id], references: [id], onDelete: Cascade)
  studio studios                  @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  items  studio_portfolio_items[]

  @@unique([page_id, slug])
  @@index([studio_id, is_published])
  @@index([order])
}

model studio_portfolio_items {
  id             String            @id @default(cuid())
  portfolio_id   String
  item_type      PortfolioItemType // PHOTO, VIDEO
  title          String?
  description    String?
  image_url      String // URL de la imagen (CDN o storage)
  thumbnail_url  String? // Thumbnail optimizado
  video_url      String? // YouTube/Vimeo embed o URL directo
  video_provider String? // "youtube", "vimeo", "direct"
  order          Int               @default(0)
  width          Int? // Para layout masonry/grid responsivo
  height         Int?
  file_size      Int? // Bytes
  created_at     DateTime          @default(now())

  portfolio studio_portfolios @relation(fields: [portfolio_id], references: [id], onDelete: Cascade)

  @@index([portfolio_id, order])
}

enum PortfolioItemType {
  PHOTO
  VIDEO
}

model studio_lead_forms {
  id                   String   @id @default(cuid())
  studio_id            String
  form_name            String // "Formulario de Contacto Principal"
  form_slug            String // URL-friendly
  title                String?
  description          String?
  success_message      String   @default("¡Gracias! Nos pondremos en contacto pronto.")
  redirect_to_packages Boolean  @default(true) // Redirigir a paquetes después
  fields_config        Json // Configuración de campos (requeridos, orden, etc.)
  is_active            Boolean  @default(true)
  submit_count         Int      @default(0)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  studio studios @relation(fields: [studio_id], references: [id], onDelete: Cascade)

  @@unique([studio_id, form_slug])
  @@index([studio_id, is_active])
}

// Portal de Clientes - Accesos públicos
model studio_client_portal_access {
  id               String    @id @default(cuid())
  studio_id        String
  event_id         String // Relacionado con manager_events
  client_email     String
  client_name      String?
  access_code      String    @unique // Código de 6-8 dígitos para login simple
  is_active        Boolean   @default(true)
  last_accessed_at DateTime?
  access_count     Int       @default(0)
  expires_at       DateTime? // Opcional: acceso temporal
  created_at       DateTime  @default(now())

  studio studios        @relation(fields: [studio_id], references: [id], onDelete: Cascade)
  event  manager_events @relation(fields: [event_id], references: [id], onDelete: Cascade)

  @@unique([studio_id, event_id, client_email])
  @@index([access_code])
  @@index([client_email])
  @@index([studio_id, is_active])
}
